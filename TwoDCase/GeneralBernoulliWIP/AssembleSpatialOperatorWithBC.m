function [A,F] = AssembleSpatialOperatorWithBC(N_X,N_Y,X,Y,g)
%UNTITLED Summary of this function goes here
%   Detailed explanation goes here
dX = X(2)-X(1);
dY = Y(2)-Y(1);
M = (N_X - 2)*(N_Y - 2);
A = zeros(M,M);
F = zeros(M,1);
G = 0.5 * g* g';

% deal with south boundary
A( 1, 1) = A(1,1)- G(1,1)/(dX^2) - G(2,2)/(dY^2) ;
A( 1, 2) = A( 1, 2) + 0.5*G(1,1)/(dX^2);
A( 1,(N_X - 2) + 1) = A( 1,(N_X - 2) + 1) + 0.5*G(2,2)/(dY^2);
A( 1,(N_X - 2) + 2) = A( 1,(N_X - 2) + 2) + 2*G(1,2)/(4*dY*dX);

for i = 2: N_X - 3
    A(  i, i) =  A(  i, i) - G(1,1)/(dX^2) - G(2,2)/(dY^2) ;
    A(  i, i+1) =  A(  i, i+1) + 0.5*G(1,1)/(dX^2);
    A(  i, i-1) = A(  i, i-1) + 0.5*G(1,1)/(dX^2);
    A(  i,(N_X - 2) + i) = A(  i,(N_X - 2) + i) + 0.5*G(2,2)/(dY^2);
    A(  i,(N_X - 2) + i+1) = A(  i,(N_X - 2) + i+1) + 2*G(1,2)/(4*dY*dX);
    A(  i,(N_X - 2) + i-1) =  A(  i,(N_X - 2) + i-1) - 2*G(1,2)/(4*dY*dX);
end

A( N_X - 2 ,N_X - 2 ) =  A( N_X - 2 ,N_X - 2 ) - G(1,1)/(dX^2) - G(2,2)/(dY^2) ;
A( N_X - 2 ,N_X - 2 -1 ) = A( N_X - 2 ,N_X - 2 -1 ) + 0.5*G(1,1)/(dX^2);
A(  N_X - 2,(N_X - 2) + N_X - 2) = A(  N_X - 2,(N_X - 2) + N_X - 2) + 0.5*G(2,2)/(dY^2);
A(  N_X - 2,(N_X - 2) + N_X - 2-1) = A(  N_X - 2,(N_X - 2) + N_X - 2-1) - 2*G(1,2)/(4*dY*dX);

% deal with middle points
for j = 1 : N_Y - 4
    %left BC
    A( j*(N_X - 2) + 1,j*(N_X - 2) + 1) = A( j*(N_X - 2) + 1,j*(N_X - 2) + 1) - G(1,1)/(dX^2) - G(2,2)/(dY^2) ;
    A( j*(N_X - 2) + 1,j*(N_X - 2) + 2) = A( j*(N_X - 2) + 1,j*(N_X - 2) + 2) + 0.5*G(1,1)/(dX^2);
    A( j*(N_X - 2) + 1,(j+1)*(N_X - 2) + 1) = A( j*(N_X - 2) + 1,(j+1)*(N_X - 2) + 1) + 0.5*G(2,2)/(dY^2);
    A( j*(N_X - 2) + 1,(j-1)*(N_X - 2) + 1) = A( j*(N_X - 2) + 1,(j-1)*(N_X - 2) + 1) + 0.5*G(2,2)/(dY^2);
    A( j*(N_X - 2) + 1,(j+1)*(N_X - 2) + 2) = A( j*(N_X - 2) + 1,(j+1)*(N_X - 2) + 2) + 2*G(1,2)/(4*dY*dX);
    A( j*(N_X - 2) + 1,(j-1)*(N_X - 2) + 2) = A( j*(N_X - 2) + 1,(j-1)*(N_X - 2) + 2) - 2*G(1,2)/(4*dY*dX);
    %middle points
    for i = 2 : N_X - 3
        A( j*(N_X - 2) + i,j*(N_X - 2) + i) = A( j*(N_X - 2) + i,j*(N_X - 2) + i) - G(1,1)/(dX^2) - G(2,2)/(dY^2) ;
        A( j*(N_X - 2) + i,j*(N_X - 2) + i+1) =  A( j*(N_X - 2) + i,j*(N_X - 2) + i+1) + 0.5*G(1,1)/(dX^2);
        A( j*(N_X - 2) + i,j*(N_X - 2) + i-1) = A( j*(N_X - 2) + i,j*(N_X - 2) + i-1) + 0.5*G(1,1)/(dX^2);
        A( j*(N_X - 2) + i,(j+1)*(N_X - 2) + i) = A( j*(N_X - 2) + i,(j+1)*(N_X - 2) + i) + 0.5*G(2,2)/(dY^2);
        A( j*(N_X - 2) + i,(j-1)*(N_X - 2) + i) = A( j*(N_X - 2) + i,(j-1)*(N_X - 2) + i) + 0.5*G(2,2)/(dY^2);
        A( j*(N_X - 2) + i,(j+1)*(N_X - 2) + i+1) = A( j*(N_X - 2) + i,(j+1)*(N_X - 2) + i+1) + 2*G(1,2)/(4*dY*dX);
        A( j*(N_X - 2) + i,(j-1)*(N_X - 2) + i+1) = A( j*(N_X - 2) + i,(j-1)*(N_X - 2) + i+1) - 2*G(1,2)/(4*dY*dX);
        A( j*(N_X - 2) + i,(j+1)*(N_X - 2) + i-1) = A( j*(N_X - 2) + i,(j+1)*(N_X - 2) + i-1) - 2*G(1,2)/(4*dY*dX);
        A( j*(N_X - 2) + i,(j-1)*(N_X - 2) + i-1) = A( j*(N_X - 2) + i,(j-1)*(N_X - 2) + i-1) + 2*G(1,2)/(4*dY*dX);
    end
    %right BC
    A( (j+1)*(N_X - 2) , (j+1)*(N_X - 2) ) = A( (j+1)*(N_X - 2) , (j+1)*(N_X - 2) ) - G(1,1)/(dX^2) - G(2,2)/(dY^2) ;
    A( (j+1)*(N_X - 2) , (j+1)*(N_X - 2) -1) = A( (j+1)*(N_X - 2) , (j+1)*(N_X - 2) -1) +  0.5*G(1,1)/(dX^2);
    A( (j+1)*(N_X - 2) , (j+2)*(N_X - 2) ) = A( (j+1)*(N_X - 2) , (j+2)*(N_X - 2) ) + 0.5*G(2,2)/(dY^2);
    A( (j+1)*(N_X - 2) , (j)*(N_X - 2)) = A( (j+1)*(N_X - 2) , (j)*(N_X - 2)) + 0.5*G(2,2)/(dY^2);
    A( (j+1)*(N_X - 2) , (j+2)*(N_X - 2) -1) =  A( (j+1)*(N_X - 2) , (j+2)*(N_X - 2) -1) - 2*G(1,2)/(4*dY*dX);
    A( (j+1)*(N_X - 2) , (j)*(N_X - 2) -1) =  A( (j+1)*(N_X - 2) , (j)*(N_X - 2) -1) + 2*G(1,2)/(4*dY*dX);
end
%deal with north boundary

 A( (N_X - 2) *(N_Y - 3) + 1, (N_X - 2) *(N_Y - 3) + 1) =  A( (N_X - 2) *(N_Y - 3) + 1, (N_X - 2) *(N_Y - 3) + 1) - G(1,1)/(dX^2) - G(2,2)/(dY^2) ;
 A( (N_X - 2) *(N_Y - 3) + 1, (N_X - 2) *(N_Y - 3) + 2) =  A( (N_X - 2) *(N_Y - 3) + 1, (N_X - 2) *(N_Y - 3) + 2)  + 0.5*G(1,1)/(dX^2);
A( (N_X - 2) *(N_Y - 3) + 1, (N_X - 2) *(N_Y - 4) + 1) = A( (N_X - 2) *(N_Y - 3) + 1, (N_X - 2) *(N_Y - 4) + 1)  + 0.5*G(2,2)/(dY^2);
A( (N_X - 2) *(N_Y - 3) + 1, (N_X - 2) *(N_Y - 4) + 2)= A( (N_X - 2) *(N_Y - 3) + 1, (N_X - 2) *(N_Y - 4) + 2) + 2*G(1,2)/(4*dY*dX);
for i = 2: N_X - 3
        A( (N_Y-3)*(N_X - 2) + i,(N_Y-3)*(N_X - 2) + i) = A( (N_Y-3)*(N_X - 2) + i,(N_Y-3)*(N_X - 2) + i) - G(1,1)/(dX^2) - G(2,2)/(dY^2) ;
        A( (N_Y-3)*(N_X - 2) + i,(N_Y-3)*(N_X - 2) + i+1) =  A( (N_Y-3)*(N_X - 2) + i,(N_Y-3)*(N_X - 2) + i+1) + 0.5*G(1,1)/(dX^2);
        A( (N_Y-3)*(N_X - 2) + i,(N_Y-3)*(N_X - 2) + i-1) = A( (N_Y-3)*(N_X - 2) + i,(N_Y-3)*(N_X - 2) + i-1) + 0.5*G(1,1)/(dX^2);
        A( (N_Y-3)*(N_X - 2) + i,((N_Y-3)-1)*(N_X - 2) + i) = A( (N_Y-3)*(N_X - 2) + i,((N_Y-3)-1)*(N_X - 2) + i) + 0.5*G(2,2)/(dY^2);
        A( (N_Y-3)*(N_X - 2) + i,((N_Y-3)-1)*(N_X - 2) + i+1) = A( (N_Y-3)*(N_X - 2) + i,((N_Y-3)-1)*(N_X - 2) + i+1) - 2*G(1,2)/(4*dY*dX);
        A( (N_Y-3)*(N_X - 2) + i,((N_Y-3)-1)*(N_X - 2) + i-1) = A( (N_Y-3)*(N_X - 2) + i,((N_Y-3)-1)*(N_X - 2) + i-1) + 2*G(1,2)/(4*dY*dX);
   
end
        A( (N_Y-2)*(N_X - 2) ,(N_Y-2)*(N_X - 2)) = A( (N_Y-2)*(N_X - 2) ,(N_Y-2)*(N_X - 2))  - G(1,1)/(dX^2) - G(2,2)/(dY^2) ;
        A( (N_Y-2)*(N_X - 2) ,(N_Y-2)*(N_X - 2)-1) = A( (N_Y-2)*(N_X - 2) ,(N_Y-2)*(N_X - 2)-1) + 0.5*G(1,1)/(dX^2);
        A( (N_Y-2)*(N_X - 2) ,((N_Y-3))*(N_X - 2) ) = A( (N_Y-2)*(N_X - 2) ,((N_Y-3))*(N_X - 2) ) + 0.5*G(2,2)/(dY^2);
        A( (N_Y-2)*(N_X - 2) ,((N_Y-3))*(N_X - 2) -1) = A( (N_Y-2)*(N_X - 2) ,((N_Y-3))*(N_X - 2) -1)+ 2*G(1,2)/(4*dY*dX);
%write in sparse form
A=sparse(A);
F = -ones(M,1);
end

