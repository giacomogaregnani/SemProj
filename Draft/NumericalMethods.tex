\subsection{Numerical Methods}

\subsubsection{Discrete Euler-Maruyama}
Given $N \in \mathbb{N}$ let us define a partition of $[0,T]$ as $P_h = \{t_i\}_{i=0}^{N}, t_i = ih, h = T/N$. The Discrete Euler-Maruyama method (DEM) for problem \eqref{eq:GeneralModel} is defined as follows
\begin{equation}\label{eq:DEM}
	\left \{
	\begin{aligned}
		X_h^d(t_{i+1}) &= f(X(t_i))h + g(X(t_i))(W(t_{i+1}) - W(t_{i})),  \\
		X_h^d(0) &= X_0.
	\end{aligned} \right .
\end{equation} 
The exit time $\tau$ is approximated with the quantity $\tau_h^d$ defined as 
\begin{equation}\label{eq:TauDEM}
	\tau_h^d = \min\{\tau_{h,e}^d,T\}, \text{ where } \tau_{h,e}^d = \min \{t_i \colon X_h^d(t_i) \notin D\}.
\end{equation}
We approximate analogously $\phi$ as
\begin{equation}\label{eq:PhiDEM}
	 \phi_h^d = \mathbbm{1}_{\{T < \tau_{h,e}^d\}}F(X_h^d(T)).
\end{equation}
It has been shown (see \cite{Gobet2000, Gobet2010, Higham2013}) that under appropriate assumptions on the functions $f$ and $g$, as well as the domain $D$ and its boundary, the weak error of the method for approximating the values of interest is of order 1/2, \textit{i.e.},
\begin{align}\label{eq:ConvDEMTau}
	|\mathbb{E}(\tau_h^d) - \mathbb{E}(\tau)| &= O(\sqrt{h}), \\
	|\mathbb{E}(\phi_h^d) - \mathbb{E}(\phi)| &= O(\sqrt{h}).
\end{align}	
It is known that the weak error for Euler-Maruyama is of order 1, therefore there is a loss of 1/2 in case of killing and reflecting boundaries \cite[Chapter 14]{Kloeden1992}. This is due to the missed exits, \textit{i.e.}, a part of the solution which lays outside the domain connecting two discrete values that are inside the domain. The following methods that we present make an effort towards correcting this behaviour.
 
\subsubsection{Continuous Euler-Maruyama. }
Let us consider the partition $P_h$ of $[0,T]$ as above. The Continuous Euler-Maruyama (CEM) method is defined as
\begin{equation}\label{eq:CEM}
	\left \{
	\begin{aligned}
		X_h^c(t) &= f(X(t_i))(t-t_i) + g(X(t_i))(W(t) - W(t_{i})),  && t_i < t \leq t_{i+1},\\
		X_h^c(0) &= X_0.
	\end{aligned} \right .
\end{equation} 
Let us remark that in case the particle does not exit the domain, $X_h^c(t_i) = X_h^d(t_i)$ for all $t_i \in P_h$. It is possible to compute the probability that a particle has exited the domain at a time $t$ between two consecutive timesteps $t_i,t_{i+1}$ when $D$ is an half-space with the following formula \cite{Gobet2001}
\begin{equation}\label{eq:CEMProb}
	\Pr (\exists t \in [ t_i,t_{i+1} ] \quad X_h^d(t) \notin D | X_h^d(t_i) = x_i, X_h^d(t_{i+1}) = x_{i+1}) = p(x_i,x_{i+1},h),
\end{equation}
with $p(x_i,x_{i+1},h)$ given by
\begin{equation}\label{eq:CEMProbHalfSpace}
	p(x_i,x_{i+1},h) = \exp\Big(-2\frac{[n\cdot(x_i - z_i)][n\cdot(x_{i+1} - z_i)]}{hn\cdot (gg^T(x_i)n)}\Big),
\end{equation}
where $z_i$ is the projection of $x_i$ on $\partial D$ and $n$ is the normal to $\partial D$ in $z_i$. At each timestep $t_{i+1}$ we compute the probability $p(x_i,x_{i+1},h)$, and then simulate a variable $U$ distributed uniformly in the interval $\left[0,1\right]$, thus obtaining a realization $u$. Hence, we counclude that the particle has left the domain for a time $t$ in $(t_i,t_{i+1})$ if $u$ is smaller than $p$. Therefore, we approximate the exit time as
\begin{equation}\label{eq:TauCEM}
	\tau_h^c = \min \{T,\tau_{h,e}^c\}, \text{ where } \tau_{h,e}^c = \min\{\min\{t_i = hi \colon X_h(t_i) \notin D\}, \min\{t_i = hi \colon u < p(x_{i-1},x_i,h) \}\},
\end{equation}
In the same way as in DEM, we can approximate $\phi$ as
\begin{equation}\label{eq:PhiCEM}
	\phi_h^c = \mathbbm{1}_{\{T < \tau_{h,e}^c\}}F(X_h^c(T)).
\end{equation}
We show the pseudocode for the implementation of CEM in Algorithm \ref{alg:algoCEM}. It has been shown \cite{Gobet2010} that under appropriate assumptions on the functions $f$ and $g$, as well as the domain $D$ and its boundary, the weak error of this method when approximating the vaules of interest is 1, \textit{i.e.},
\begin{align}\label{eq:ConvCEMPhi}
	|\mathbb{E}(\tau_h^c) - \mathbb{E}(\tau)| = O(h), \\
	|\mathbb{E}(\phi_h^c) - \mathbb{E}(\phi)| = O(h).
\end{align}
This result implies that computing the probability of exit at each timestep it is possible to avoid the phenomenon of the missed exits, restoring the weak order 1 of the standard Euler-Maruyama method.

\begin{algorithm}[t]
\caption{Continuous Euler-Maruyama}
\For{$t_i \in P_h$ }{
	$X(t_{i+1}) = f(X(t_i))h + g(X(t_i))(W(t_{i+1})-W(t_i))$ \;
  	\eIf{$X(t_{i+1}) \notin D$}{
    		$\tau_h^c = t_{i+1}$ \;
		$\phi_h^c = F(X_h^c(t_{i+1}))$ \;
		\Return \;
   	}{
   	compute $p = p(x_i,x_{i+1},h)$ \;
	simulate $u \sim$ Unif$(0,1)$ \;
	\If{$u < p$}{
		$\tau_h^c = t_{i+1}$ \;
		$\phi_h^c = F(X_h^c(t_{i+1}))$ \;
		\Return \;
		}
  	}
 }
\label{alg:algoCEM}
\end{algorithm}

\input{Adaptivity}

\subsubsection{Reflecting boundaries}
The reflecting boundaries are treated in the same way for both DEM and CEM. Let us denote by $\Gamma_k$ and $\Gamma_r$ the killing and reflecting subsets of $\partial D$, \textit{i.e.}
\begin{equation}\label{eq:Boundaries}
	\Gamma_r \cup \Gamma_k = \partial D, \quad \Gamma_r \cap \Gamma_k = \emptyset
\end{equation} 
If for a timestep of $t_i \in P_h$, $X(t_i)$ is not in $D$ and has crossed $\Gamma_r$ at a time $t_{i-1} < t < t_i$, we update the solution to be the normal reflection inside $D$ of $X(t_i)$. This procedure does not spoil the correctness of the numerical solution \cite{Helmuth}.



